{% extends "base.html" %}

{% block title %}Submit New Listing | UCR HousingConnect{% endblock %}

{% block head %}
<style>
    .unit-option {
        animation: fadeIn 0.3s ease-out forwards;
    }
    
    #unit-options-container:empty::after {
        content: "No unit options added yet.";
        display: block;
        padding: 0.75rem;
        text-align: center;
        color: #6b7280;
        font-style: italic;
        background-color: #f9fafb;
        border-radius: 0.375rem;
        border: 1px dashed #d1d5db;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Submit a New Housing Listing</h1>
    
    <!-- Error messages -->
    {% if errors %}
    <div class="bg-red-100 text-red-700 p-4 rounded-lg mb-6">
        <p class="font-medium">Please correct the following errors:</p>
        <ul class="list-disc list-inside mt-2">
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <form method="POST" class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6" x-data="{ isMultiUnit: false }">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
            <!-- Title -->
            <div class="md:col-span-2">
                <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Listing Title*</label>
                <input type="text" name="title" id="title" required
                       value="{{ form.title if form else '' }}"
                       class="form-input"
                       placeholder="e.g., Spacious 2BD Apartment near UCR">
            </div>
            
            <!-- Description -->
            <div class="md:col-span-2">
                <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description*</label>
                <textarea name="description" id="description" rows="5" required
                          class="form-input"
                          placeholder="Describe the property, highlight key features, mention nearby amenities...">{{ form.description if form else '' }}</textarea>
            </div>
            
            <!-- Address -->
            <div class="md:col-span-2">
                <label for="address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Address*</label>
                <input type="text" name="address" id="address" required
                       value="{{ form.address if form else '' }}"
                       class="form-input"
                       placeholder="Street address, City, State, ZIP">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This will be used to place the listing on the map</p>
            </div>
            
            <!-- Property Details -->
            <div>
                <label for="property_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Property Type*</label>
                <select name="property_type" id="property_type" required
                        x-on:change="isMultiUnit = $event.target.value === 'apartment'"
                        class="form-select">
                    <option value="">Select type...</option>
                    <option value="apartment" {% if form and form.property_type == 'apartment' %}selected{% endif %}>Apartment</option>
                    <option value="house" {% if form and form.property_type == 'house' %}selected{% endif %}>House</option>
                    <option value="room" {% if form and form.property_type == 'room' %}selected{% endif %}>Room</option>
                    <option value="townhouse" {% if form and form.property_type == 'townhouse' %}selected{% endif %}>Townhouse</option>
                    <option value="condo" {% if form and form.property_type == 'condo' %}selected{% endif %}>Condo</option>
                </select>
            </div>
            
            <!-- Available Date -->
            <div>
                <label for="available_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Available From</label>
                <input type="date" name="available_date" id="available_date"
                       value="{{ form.available_date if form else '' }}"
                       class="form-input">
            </div>
            
            <!-- Multi-unit toggle for apartments -->
            <div class="md:col-span-2" x-show="isMultiUnit" x-transition>
                <div class="flex items-center mb-2">
                    <input type="checkbox" name="is_multi_unit" id="is_multi_unit" value="true"
                           class="form-checkbox"
                           x-model="isMultiUnit">
                    <label for="is_multi_unit" class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">
                        This is a multi-unit property (e.g., apartment complex)
                    </label>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                    For apartment complexes with multiple floor plans or units, you can specify different bedroom and bathroom options.
                </p>
            </div>
            
            <!-- Single Unit Details (visible when not multi-unit) -->
            <div x-show="!isMultiUnit" class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                <!-- Price -->
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monthly Rent*</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 dark:text-gray-400 sm:text-sm">$</span>
                        </div>
                        <input type="number" name="price" id="price" required min="0" step="0.01"
                               value="{{ form.price if form else '' }}"
                               class="form-input pl-7" 
                               placeholder="0.00">
                    </div>
                </div>
                
                <!-- Square Feet -->
                <div>
                    <label for="square_feet" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Square Feet</label>
                    <input type="number" name="square_feet" id="square_feet" min="0"
                           value="{{ form.square_feet if form else '' }}"
                           class="form-input"
                           placeholder="e.g., 850">
                </div>
                
                <!-- Bedrooms -->
                <div>
                    <label for="bedrooms" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bedrooms*</label>
                    <input type="number" name="bedrooms" id="bedrooms" required min="0" step="1"
                           value="{{ form.bedrooms if form else '' }}"
                           class="form-input"
                           placeholder="e.g., 2">
                </div>
                
                <!-- Bathrooms -->
                <div>
                    <label for="bathrooms" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bathrooms*</label>
                    <input type="number" name="bathrooms" id="bathrooms" required min="0" step="0.5"
                           value="{{ form.bathrooms if form else '' }}"
                           class="form-input"
                           placeholder="e.g., 1.5">
                </div>
            </div>
            
            <!-- Multi-Unit Details (visible when multi-unit is checked) -->
            <div x-show="isMultiUnit" x-transition class="md:col-span-2 border border-ucr-blue-100 dark:border-ucr-blue-800 rounded-lg p-4 bg-ucr-blue-50 dark:bg-ucr-blue-900/30">
                <h3 class="text-lg font-medium text-ucr-blue-800 dark:text-ucr-blue-200 mb-3">Unit Options</h3>
                
                <!-- Price Range -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Starting Price*</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 dark:text-gray-400 sm:text-sm">$</span>
                            </div>
                            <input type="number" name="price" id="price" required min="0" step="0.01"
                                   value="{{ form.price if form else '' }}"
                                   class="form-input pl-7" 
                                   placeholder="0.00">
                        </div>
                    </div>
                    <div>
                        <label for="square_feet" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Approximate Sq Ft Range</label>
                        <input type="text" name="square_feet_range" id="square_feet_range"
                               placeholder="e.g., 600-1200" 
                               class="form-input">
                    </div>
                </div>
                
                <!-- Bedroom/Bathroom Ranges -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="min_bedrooms" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Min Bedrooms</label>
                        <input type="number" name="min_bedrooms" id="min_bedrooms" min="0" step="1"
                               class="form-input" placeholder="0">
                    </div>
                    <div>
                        <label for="max_bedrooms" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Bedrooms</label>
                        <input type="number" name="max_bedrooms" id="max_bedrooms" min="0" step="1"
                               class="form-input" placeholder="5">
                    </div>
                    <div>
                        <label for="min_bathrooms" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Min Bathrooms</label>
                        <input type="number" name="min_bathrooms" id="min_bathrooms" min="0" step="0.5"
                               class="form-input" placeholder="1">
                    </div>
                    <div>
                        <label for="max_bathrooms" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Bathrooms</label>
                        <input type="number" name="max_bathrooms" id="max_bathrooms" min="0" step="0.5"
                               class="form-input" placeholder="3">
                    </div>
                </div>
                
                <!-- Unit Options Builder -->
                <div class="mb-4">
                    <div class="flex flex-wrap items-end gap-2 mb-2">
                        <div>
                            <label for="option_name" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Unit Name</label>
                            <input type="text" id="option_name" class="text-sm py-1.5 form-input" placeholder="Studio">
                        </div>
                        <div>
                            <label for="option_beds" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Beds</label>
                            <input type="number" id="option_beds" min="0" step="1" class="text-sm py-1.5 form-input w-20" placeholder="0">
                        </div>
                        <div>
                            <label for="option_baths" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Baths</label>
                            <input type="number" id="option_baths" min="0" step="0.5" class="text-sm py-1.5 form-input w-20" placeholder="1">
                        </div>
                        <div>
                            <label for="option_sqft" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Sq Ft</label>
                            <input type="number" id="option_sqft" min="0" step="1" class="text-sm py-1.5 form-input w-20" placeholder="500">
                        </div>
                        <div>
                            <label for="option_price" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Price</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                    <span class="text-gray-500 dark:text-gray-400 text-xs">$</span>
                                </div>
                                <input type="number" id="option_price" min="0" step="0.01" class="text-sm py-1.5 form-input pl-6 w-32" placeholder="1,000">
                            </div>
                        </div>
                        <button type="button" onclick="addUnitOption()" class="bg-ucr-blue-600 hover:bg-ucr-blue-700 text-white rounded-md px-3 py-1.5 text-sm font-medium">
                            Add Option
                        </button>
                    </div>
                    <div id="unit-options-container" class="space-y-2 mt-2"></div>
                    <input type="hidden" name="unit_options" id="unit_options_json" value="">
                </div>
            </div>
            
            <!-- Contact Info -->
            <div>
                <label for="contact_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contact Email*</label>
                <input type="email" name="contact_email" id="contact_email" required
                       value="{{ form.contact_email if form else '' }}"
                       class="form-input"
                       placeholder="your@email.com">
            </div>
            
            <div>
                <label for="contact_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contact Phone</label>
                <input type="tel" name="contact_phone" id="contact_phone"
                       value="{{ form.contact_phone if form else '' }}"
                       class="form-input"
                       placeholder="(123) 456-7890">
            </div>
            
            <!-- Amenities -->
            <div class="md:col-span-2 mt-2">
                <span class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amenities</span>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {% for amenity in amenities %}
                    <div class="flex items-center">
                        <input type="checkbox" name="amenities" id="amenity-{{ amenity.id }}" value="{{ amenity.id }}"
                               class="form-checkbox"
                               {% if form and amenity.id|string in form.getlist('amenities') %}checked{% endif %}>
                        <label for="amenity-{{ amenity.id }}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ amenity.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="md:col-span-2 mt-6">
                <button type="submit" class="btn-primary w-full">
                    Submit Listing
                </button>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">* Required fields</p>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Unit options management
    let unitOptions = [];
    
    function addUnitOption() {
        const name = document.getElementById('option_name').value.trim();
        const beds = parseInt(document.getElementById('option_beds').value, 10);
        const baths = parseFloat(document.getElementById('option_baths').value);
        const sqft = parseInt(document.getElementById('option_sqft').value, 10);
        const price = parseFloat(document.getElementById('option_price').value);
        
        if (!name || isNaN(beds) || isNaN(baths) || isNaN(price)) {
            alert('Please fill in all fields for the unit option.');
            return;
        }
        
        const option = {
            name,
            bedrooms: beds,
            bathrooms: baths,
            square_feet: isNaN(sqft) ? null : sqft,
            price
        };
        
        unitOptions.push(option);
        updateUnitOptionsDisplay();
        
        // Clear the inputs
        document.getElementById('option_name').value = '';
        document.getElementById('option_beds').value = '';
        document.getElementById('option_baths').value = '';
        document.getElementById('option_sqft').value = '';
        document.getElementById('option_price').value = '';
    }
    
    function removeUnitOption(index) {
        unitOptions.splice(index, 1);
        updateUnitOptionsDisplay();
    }
    
    function updateUnitOptionsDisplay() {
        const container = document.getElementById('unit-options-container');
        container.innerHTML = '';
        
        unitOptions.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'flex justify-between items-center p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm unit-option';
            
            const detailsSpan = document.createElement('span');
            detailsSpan.className = 'text-sm';
            detailsSpan.innerHTML = `<strong>${option.name}:</strong> ${option.bedrooms}bd / ${option.bathrooms}ba`;
            if (option.square_feet) {
                detailsSpan.innerHTML += ` / ${option.square_feet} sqft`;
            }
            detailsSpan.innerHTML += ` - <span class="text-ucr-blue-600 dark:text-ucr-blue-400 font-medium">$${option.price.toFixed(2)}</span>`;
            
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300';
            removeButton.innerHTML = '<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
            removeButton.onclick = () => removeUnitOption(index);
            
            optionDiv.appendChild(detailsSpan);
            optionDiv.appendChild(removeButton);
            container.appendChild(optionDiv);
        });
        
        // Update the hidden input with JSON data
        document.getElementById('unit_options_json').value = JSON.stringify(unitOptions);
    }
    
    // Initialize AlpineJS data based on form values if present
    document.addEventListener('DOMContentLoaded', () => {
        // Check for property type to set isMultiUnit
        const propertyType = document.getElementById('property_type').value;
        if (propertyType === 'apartment') {
            // This will be watched by Alpine's x-model
            document.getElementById('is_multi_unit').checked = true;
        }
    });
</script>
{% endblock %} 