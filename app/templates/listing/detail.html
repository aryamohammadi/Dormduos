{% extends "base.html" %}

{% block title %}{{ listing.title }} - UCR HousingConnect{% endblock %}

{% block head %}
<style>
    .map-container {
        height: 400px;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .distance-info {
        @apply mt-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg;
    }
    
    .distance-item {
        @apply flex items-center justify-between py-2 border-b border-gray-200 dark:border-gray-700 last:border-0;
    }
    
    .distance-label {
        @apply flex items-center text-gray-600 dark:text-gray-400;
    }
    
    .distance-value {
        @apply font-medium text-ucr-blue-700 dark:text-ucr-blue-400;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Title and Price -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-ucr-blue-700 dark:text-ucr-blue-400 mb-2">{{ listing.title }}</h1>
                <p class="text-2xl font-bold text-ucr-gold-600 dark:text-ucr-gold-400">${{ "%.2f"|format(listing.price) }}</p>
            </div>
            
            <!-- Property Details -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Property Details</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="flex items-center">
                        <i class="fas fa-bed text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.bedrooms }} Bedrooms</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-bath text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.bathrooms }} Bathrooms</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-home text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.property_type }}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-calendar text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">Available: {{ listing.available_date.strftime('%B %d, %Y') }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Description -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Description</h2>
                <p class="text-gray-700 dark:text-gray-300 whitespace-pre-line">{{ listing.description }}</p>
            </div>
            
            <!-- Amenities -->
            {% if listing.amenities %}
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Amenities</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {% for amenity in listing.amenities %}
                    <div class="flex items-center">
                        <i class="fas fa-check text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ amenity.name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Contact Information -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Contact Information</h2>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <i class="fas fa-phone text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.contact_phone }}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-envelope text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.contact_email }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('listing.edit', listing_id=listing.id) }}" class="btn-outline">
                    <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Edit Listing
                </a>
                <button 
                    onclick="if(confirm('Are you sure you want to delete this listing? This cannot be undone.')) { document.getElementById('delete-form').submit(); }" 
                    class="btn bg-red-600 text-white hover:bg-red-700 focus:ring-red-500">
                    <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
                <form id="delete-form" action="{{ url_for('listing.delete', listing_id=listing.id) }}" method="POST" class="hidden"></form>
            </div>
        </div>
        
        <!-- Map and Additional Info -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Map Container -->
            <div id="map" class="map-container" 
                 data-lat="{{ listing.latitude }}" 
                 data-lng="{{ listing.longitude }}"
                 data-title="{{ listing.title }}"
                 style="height: 400px;"></div>
            
            <!-- Distance Information -->
            <div class="distance-info">
                <h3 class="text-lg font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-3">Distance to UCR</h3>
                <div class="distance-item">
                    <div class="distance-label">
                        <i class="fas fa-car text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span>Driving</span>
                    </div>
                    <span class="distance-value" id="driving-distance">Calculating...</span>
                </div>
                <div class="distance-item">
                    <div class="distance-label">
                        <i class="fas fa-walking text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span>Walking</span>
                    </div>
                    <span class="distance-value" id="walking-distance">Calculating...</span>
                </div>
            </div>
            
            <!-- Posted Date -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                <p class="text-sm text-gray-500 dark:text-gray-400">Posted on</p>
                <p class="font-medium dark:text-white">{{ listing.created_at.strftime('%B %d, %Y') }}</p>
                {% if listing.created_at != listing.updated_at %}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Updated on</p>
                <p class="font-medium dark:text-white">{{ listing.updated_at.strftime('%B %d, %Y') }}</p>
                {% endif %}
            </div>
            
            <!-- Similar Listings (placeholder) -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-2 dark:text-white">Similar Listings</h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Coming soon...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Google Maps Integration -->
<script>
    console.log("Detail page map initialization starting...");
    
    // UCR Campus coordinates
    const UCR_CAMPUS = {
        lat: 33.9737,
        lng: -117.3281
    };
    
    let map;
    let directionsService;
    let directionsRenderer;
    
    // Error handler for Google Maps
    function gm_authFailure() {
        console.error("Google Maps authentication failed - invalid API key");
        alert("Google Maps API key is invalid or has restrictions that prevent it from loading.");
    }
    
    // Initialize Google Maps
    async function initMap() {
        console.log("Initializing Google Maps for detail page...");
        
        // Get property coordinates from data attributes
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error("Map container element not found!");
            return;
        }
        
        const propertyLat = parseFloat(mapElement.getAttribute('data-lat'));
        const propertyLng = parseFloat(mapElement.getAttribute('data-lng'));
        const propertyTitle = mapElement.getAttribute('data-title');
        
        if (isNaN(propertyLat) || isNaN(propertyLng)) {
            console.error("Invalid property coordinates");
            return;
        }
        
        const propertyPosition = { lat: propertyLat, lng: propertyLng };
        
        try {
            // Initialize the map centered on the property
            map = new google.maps.Map(mapElement, {
                center: propertyPosition,
                zoom: 14,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            // Add property marker
            new google.maps.Marker({
                position: propertyPosition,
                map: map,
                title: propertyTitle || 'Property'
            });
            
            // Add UCR campus marker
            new google.maps.Marker({
                position: UCR_CAMPUS,
                map: map,
                title: 'UCR Campus',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#003DA5',
                    fillOpacity: 1,
                    strokeColor: '#FFD100',
                    strokeWeight: 2
                }
            });
            
            // Initialize directions service
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true
            });
            
            // Calculate route from property to UCR
            calculateRouteToUCR(propertyLat, propertyLng);
            
            console.log("Detail page map initialized successfully");
        } catch (error) {
            console.error("Error initializing Google Maps:", error);
        }
    }
    
    // Calculate route from property to UCR
    function calculateRouteToUCR(propertyLat, propertyLng) {
        if (!directionsService) return;
        
        const request = {
            origin: { lat: propertyLat, lng: propertyLng },
            destination: UCR_CAMPUS,
            travelMode: google.maps.TravelMode.DRIVING
        };
        
        try {
            directionsService.route(request, function(result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                    
                    // Get distance and time
                    const route = result.routes[0].legs[0];
                    const drivingDistanceElement = document.getElementById('driving-distance');
                    if (drivingDistanceElement) {
                        drivingDistanceElement.textContent = route.distance.text;
                    }
                    
                    // Calculate walking distance too
                    calculateWalkingDistance(propertyLat, propertyLng);
                } else {
                    console.error('Directions request failed due to ' + status);
                    
                    const drivingDistanceElement = document.getElementById('driving-distance');
                    if (drivingDistanceElement) {
                        drivingDistanceElement.textContent = 'Unable to calculate';
                    }
                }
            });
        } catch (error) {
            console.error('Error calculating directions:', error);
        }
    }
    
    // Calculate walking distance
    function calculateWalkingDistance(propertyLat, propertyLng) {
        if (!directionsService) return;
        
        const request = {
            origin: { lat: propertyLat, lng: propertyLng },
            destination: UCR_CAMPUS,
            travelMode: google.maps.TravelMode.WALKING
        };
        
        try {
            directionsService.route(request, function(result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    // Get walking distance
                    const route = result.routes[0].legs[0];
                    const walkingDistanceElement = document.getElementById('walking-distance');
                    if (walkingDistanceElement) {
                        walkingDistanceElement.textContent = route.distance.text + ' (' + route.duration.text + ')';
                    }
                } else {
                    console.error('Walking directions request failed due to ' + status);
                    
                    const walkingDistanceElement = document.getElementById('walking-distance');
                    if (walkingDistanceElement) {
                        walkingDistanceElement.textContent = 'Unable to calculate';
                    }
                }
            });
        } catch (error) {
            console.error('Error calculating walking directions:', error);
        }
    }
    
    // Make initMap available globally
    window.initMap = initMap;
</script>

<!-- Load Google Maps API with the API key -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
{% endblock %} 